---
icon: chart-scatter-3d
---

# GraphRunner: A Post-Exploitation Toolset for Microsoft 365

{% hint style="warning" %}
We built a post-compromise toolset called [GraphRunner](https://github.com/dafthack/GraphRunner/) for interacting with the Microsoft Graph API. It provides various tools for performing reconnaissance, persistence, and pillaging of data from a Microsoft Entra ID (Azure AD) account. Below are some of the main features. At the end of the blog post, make sure to take a peek at the potential attack path scenarios we have laid out. There are a few in there we think may be quite interesting to both offensive and defensive security team members.
{% endhint %}

#### **Main Features:**

* Search and export email
* Search and export SharePoint and OneDrive files accessible to a user
* Search all Teams chats and channels visible to the user and export full conversations
* Deploy malicious apps
* Discover misconfigured mailboxes that are exposed
* Clone security groups to carry out watering hole attacks
* Find groups that can be modified directly by your user or where membership rules can be abused to gain access
* Search all user attributes for specific terms
* Leverage a GUI built on the Graph API to pillage a user’s account
* Dump conditional access policies
* Dump app registrations and external apps including consent and scope to identify potentially malicious apps
* Tools to complete OAuth flow during consent grant attacks
* Continuously refresh your token package
* GraphRunner doesn’t rely on any third-party libraries or modules
* Works with Windows and Linux

You can find GraphRunner here: [https://github.com/dafthack/GraphRunner/](https://github.com/dafthack/GraphRunner/)



***

There are three main pieces to GraphRunner:

* **GraphRunner.ps1 –** A PowerShell script containing a number of modules for post-compromise recon, persistence, and pillaging of an account.
* **GraphRunnerGUI.html** – An HTML graphic user interface to be used with an access token. Provides various modules around enumeration and pillaging data from services such as Outlook, SharePoint, OneDrive, and Teams.
* **PHPRedirector** -A basic PHP script that can be used to capture OAuth authorization codes during an OAuth consent flow and a Python script to automatically complete the flow to obtain access tokens.

***

### GraphRunner PowerShell

{% hint style="warning" %}
GraphRunner includes a PowerShell set of tools to assist with carrying out various attacks during post-exploitation of a Microsoft Entra ID (Azure AD) tenant. Most of the modules rely on having authenticated access tokens. To assist with this, there are multiple modules for obtaining and working with both user and application (service principal) tokens. The majority of modules don’t require a privileged account.
{% endhint %}

To get started, import GraphRunner into a new PowerShell session.

```
Import-Module .\GraphRunner.ps1
```

<figure><img src="https://www.blackhillsinfosec.com/wp-content/uploads/2023/10/Untitled-21.png" alt="" height="214" width="689"><figcaption></figcaption></figure>

Here’s a high-level summary of each module included in the PowerShell script:

**Authentication**

* <mark style="color:green;">**Get-GraphTokens**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Authenticate as a user to Microsoft Graph</mark>
* <mark style="color:green;">**Invoke-RefreshGraphTokens**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Use a refresh token to obtain new access tokens</mark>
* <mark style="color:green;">**Get-AzureAppTokens**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Complete OAuth flow as an app to obtain access tokens</mark>
* <mark style="color:green;">**Invoke-RefreshAzureAppTokens**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Use a refresh token and app credentials to refresh a token</mark>
* <mark style="color:green;">I</mark><mark style="color:green;">**nvoke-AutoTokenRefresh**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Refresh tokens at an interval</mark>

**Recon & Enumeration Modules**

* <mark style="color:green;">**Invoke-GraphRecon**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Performs general recon for org info, user settings, directory sync settings, etc.</mark>
* <mark style="color:green;">**Invoke-DumpCAPS**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Gets conditional access policies</mark>
* <mark style="color:green;">**Invoke-DumpApps**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Gets app registrations and external enterprise apps, along with consent and scope info</mark>
* <mark style="color:green;">**Get-AzureADUsers**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Gets user directory</mark>
* <mark style="color:green;">**Get-SecurityGroups**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Gets security groups and members</mark>
* <mark style="color:green;">**Get-UpdatableGroups**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Gets groups that may be able to be modified by the current user</mark>
* <mark style="color:green;">**Get-DynamicGroups**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Finds dynamic groups and displays membership rules</mark>
* <mark style="color:green;">**Get-SharePointSiteURLs**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Gets a list of SharePoint site URLs visible to the current user</mark>
* <mark style="color:green;">**Invoke-GraphOpenInboxFinder**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Checks each user’s inbox in a list to see if they are readable</mark>
* <mark style="color:green;">**Get-TenantID**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Retrieves the tenant GUID from the domain name</mark>

**Persistence Modules**

* <mark style="color:green;">**Invoke-InjectOAuthApp**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Injects an app registration into the tenant</mark>
* <mark style="color:green;">**Invoke-SecurityGroupCloner**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Clones a security group while using an identical name and member list but can inject another user as well</mark>
* <mark style="color:green;">**Invoke-InviteGuest**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Invites a guest user to the tenant</mark>
* <mark style="color:green;">**Invoke-AddGroupMember**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Adds a member to a group</mark>

**Pillage Modules**

* <mark style="color:green;">**Invoke-SearchSharePointAndOneDrive**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Search across all SharePoint sites and OneDrive drives visible to the user</mark>
* <mark style="color:green;">**Invoke-ImmersiveFileReader**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Open restricted files with the immersive reader</mark>
* <mark style="color:green;">**Invoke-SearchMailbox**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Has the ability to do deep searches across a user’s mailbox and can export messages</mark>
* <mark style="color:green;">**Invoke-SearchTeams**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Can search all Teams messages in all channels that are readable by the current user</mark>
* <mark style="color:green;">**Invoke-SearchUserAttributes**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Search for terms across all user attributes in a directory</mark>
* <mark style="color:green;">**Get-Inbox**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Gets the latest inbox items from a mailbox and can be used to read other user mailboxes (shared)</mark>
* <mark style="color:green;">**Get-TeamsChat**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Downloads full Teams chat conversations</mark>

**Invoke-GraphRunner Module**

* <mark style="color:green;">**Invoke-GraphRunner**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Runs Invoke-GraphRecon, Get-AzureADUsers, Get-SecurityGroups, Invoke-DumpCAPS, Invoke-DumpApps, and then uses the default\_detectors.json file to search with Invoke-SearchMailbox, Invoke-SearchSharePointAndOneDrive, and Invoke-SearchTeams.</mark>

**Supplemental Modules**

* <mark style="color:green;">**Invoke-AutoOAuthFlow**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Automates the OAuth flow completion to obtain access and refresh keys when a user grants consent to an app registration</mark>
* <mark style="color:green;">**Invoke-DeleteOAuthApp**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Delete an OAuth App</mark>
* <mark style="color:green;">**Invoke-DeleteGroup**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Delete a group</mark>
* <mark style="color:green;">**Invoke-RemoveGroupMember**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Module for removing users/members from groups</mark>
* <mark style="color:green;">**Invoke-DriveFileDownload**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Has the ability to download single files from SharePoint and OneDrive as the current user</mark>
* <mark style="color:green;">**Invoke-CheckAccess**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Check if tokens are valid</mark>
* <mark style="color:green;">**Invoke-HTTPServer**</mark> <mark style="color:green;"></mark><mark style="color:green;">– A basic web server to use for accessing the emailviewer that is output from Invoke-SearchMailbox</mark>
* <mark style="color:green;">**Invoke-BruteClientIDAccess**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Test different client\_id’s against MSGraph to determine permissions</mark>
* <mark style="color:green;">**Invoke-ImportTokens**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Import tokens from other tools for use in GraphRunner</mark>
* <mark style="color:green;">**Get-UserObjectID**</mark> <mark style="color:green;"></mark><mark style="color:green;">– Retrieves an Object ID for a user</mark>



***

## REFERENCES

* [https://www.blackhillsinfosec.com/introducing-graphrunner/](https://www.blackhillsinfosec.com/introducing-graphrunner/)
* [https://medium.com/@AlbertGlenn/loot-exchange-teams-and-sharepoint-with-graph-runner-d941d62d6c4f](https://medium.com/@AlbertGlenn/loot-exchange-teams-and-sharepoint-with-graph-runner-d941d62d6c4f)
* [https://github.com/dafthack/GraphRunner/blob/main/GraphRunner.ps1](https://github.com/dafthack/GraphRunner/blob/main/GraphRunner.ps1)
