# â™Ž Yara Guide

## What is Yara?

_"The pattern matching swiss knife for malware researchers (and everyone else)" (_[_Virustotal., 2020_](https://virustotal.github.io/yara/)_)_

## Creating Basic Yara Rule

```
# nano myfirstrule.yar

rule examplerule {
        condition: true
}
```

```
#Looking for a file that exist
yara myfirstrule.yar somefile

#Looking for a file that does not exist
yara myfirstrule.yar somefilexyz
```



## Yara Conditions

| <p>Desc<br></p>                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><strong>Meta:</strong> This section of a Yara rule is reserved for descriptive information by the author of the rule. For example, you can use <code>desc</code>, short for description, to summarise what your rule checks for. Anything within this section does not influence the rule itself. Similar to commenting code, it is useful to summarise your rule.<br></p>                                                                                  |
| <p><strong>Strings:</strong><br></p><pre class="language-yaml"><code class="lang-yaml">rule helloworld_checker{
	strings:
		$hello_world = "Hello World!"

	condition:
		$hello_world
}
</code></pre><p></p><pre class="language-yaml"><code class="lang-yaml">rule helloworld_checker{
	strings:
		$hello_world = "Hello World!"
		$hello_world_lowercase = "hello world"
		$hello_world_uppercase = "HELLO WORLD"

	condition:
		any of them
}
</code></pre> |
| <p><strong>Conditions:</strong></p><pre class="language-yaml"><code class="lang-yaml">rule helloworld_checker{
	strings:
		$hello_world = "Hello World!"

	condition:
        #hello_world &#x3C;= 10
}
</code></pre><p>The rule will now:</p><p>1. Look for the "Hello World!" string<br>2. Only say the rule matches if there are less than or equal to ten occurrences of the "Hello World!" string<br></p>                                                 |
| Weight                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

### Combining Keywords

* and
* or
* not

```
rule helloworld_checker{
	strings:
		$hello_world = "Hello World!" 
        
        condition:
	        $hello_world and filesize < 10KB 
}
```



### Anatomy of Yara Rules

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption><p><a href="https://blog.securitybreak.io/security-infographics-9c4d3bd891ef#18dd">https://blog.securitybreak.io/security-infographics-9c4d3bd891ef#18dd</a></p></figcaption></figure>



## Yara Modules

### Libraries

* Cuckoo
* Python PE



## Yara Tools

### LOKI

LOKI is a free open-source IOC (_Indicator of Compromise_) scanner created/written by Florian Roth.

**Based on the GitHub page, detection is based on 4 methods:**

1. File Name IOC Check
2. Yara Rule Check (we are here)
3. Hash Check
4. C2 Back Connect Check

### THOR

THOR _Lite_ is Florian's newest multi-platform IOC AND YARA scanner. There are precompiled versions for Windows, Linux, and macOS. A nice feature with THOR Lite is its scan throttling to limit exhausting CPU resources. For more information and/or to download the binary, start [here](https://www.nextron-systems.com/thor-lite/). You need to subscribe to their mailing list to obtain a copy of the binary. Note that THOR is geared towards corporate customers. THOR Lite is the free version.

### FENRIR

This is the 3rd [tool](https://github.com/Neo23x0/Fenrir) created by Neo23x0 (Florian Roth). You guessed it; the previous 2 are named above. The updated version was created to address the issue from its predecessors, where requirements must be met for them to function. Fenrir is a bash script; it will run on any system capable of running bash (nowadays even Windows).&#x20;

### YARA

YAYA was created by the [EFF](https://www.eff.org/deeplinks/2020/09/introducing-yaya-new-threat-hunting-tool-eff-threat-lab) (_Electronic Frontier Foundation_) and released in September 2020. Based on their website, "_YAYA is a new open-source tool to help researchers manage multiple YARA rule repositories. YAYA starts by importing a set of high-quality YARA rules and then lets researchers add their own rules, disable specific rulesets, and run scans of files._"





## Using LOKI

```
# Help Menu
python loki.py -h

# Update
python loki.py --update

# Run Loki
python loki.py -p .
```

\


## YarGen

### What is YarGen?

From the README - "_The main principle is the creation of yara rules from strings found in malware files while removing all strings that also appear in goodware files. Therefore yarGen includes a big goodware strings and opcode database as ZIP archives that have to be extracted before the first use_."



```
# Update
python3 yarGen.py --update

# Generate Yara Rule for a File
python3 yarGen.py -m <file name> --excludegood -o <ouput name>.yar 

# Test the yara rule
yara file2.yar file2/index.php


```

* `-m` is the path to the files you want to generate rules for
* `--excludegood` force to exclude all goodware strings (_these are strings found in legitimate software and can increase false positives_)
* `-o` location & name you want to output the Yara rule



{% hint style="info" %}
**Note:** Another tool created to assist with this is called [yarAnalyzer](https://github.com/Neo23x0/yarAnalyzer/) (you guessed it - created by Florian Roth). We will not examine that tool in this room, but you should read up on it, especially if you decide to start creating your own Yara rules.
{% endhint %}

**Further Reading on creating Yara rules and using yarGen:**

* [https://www.bsk-consulting.de/2015/02/16/write-simple-sound-yara-rules/](https://www.bsk-consulting.de/2015/02/16/write-simple-sound-yara-rules/)\

* [https://www.bsk-consulting.de/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/](https://www.bsk-consulting.de/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/)
* [https://www.bsk-consulting.de/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/](https://www.bsk-consulting.de/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)



## Valhalla

Valhalla is an online Yara feed created and hosted by [Nextron-Systems](https://www.nextron-systems.com/valhalla/) (erm, Florian Roth).

Per the website, "_Valhalla boosts your detection capabilities with the power of thousands of hand-crafted high-quality YARA rules._"

{% embed url="https://valhalla.nextron-systems.com/info/search" %}
Valhalla
{% endembed %}

